FROM docker.io/rust:1.74.1 as builder1
ARG ARG_THAPO_SKA_ENV_FILE
RUN apt-get update && apt-get full-upgrade -y && apt-get install --no-install-recommends -y npm && apt-get clean && rm -rf /var/lib/apt/lists/* && \
    npm install -g tailwindcss@3.3.6 && \
    rustup install nightly-2023-12-11 && \
    rustup default nightly-2023-12-11 && \
    rustup target add wasm32-unknown-unknown && \
    cargo install trunk

FROM builder1 as builder2
ARG ARG_THAPO_SKA_ENV_PROFILE
ENV THAPO_SKA_ENV_FILE=/app/frontend/.env.${ARG_THAPO_SKA_ENV_PROFILE}
WORKDIR /app
COPY ./rust-toolchain.toml /app/rust-toolchain.toml
COPY ./Cargo.toml /app/Cargo.toml
COPY ./Cargo.lock /app/Cargo.lock
COPY ./backend/Cargo.toml /app/backend/Cargo.toml
COPY ./backend/src/lib.rs /app/backend/src/lib.rs
COPY ./backend/src/bin /app/backend/src/bin
COPY ./frontend /app/frontend
COPY ./migration/Cargo.toml /app/migration/Cargo.toml
COPY ./migration/src/lib.rs /app/migration/src/lib.rs
WORKDIR /app/frontend
RUN npm ci && trunk build --release --public-url /app

FROM docker.io/nginx:1.25.3
ARG ARG_THAPO_SKA_ENV_PROFILE
ENV THAPO_SKA_ENV_FILE=/app/.env.${ARG_THAPO_SKA_ENV_PROFILE}
RUN apt-get update && apt-get clean && rm -rf /var/lib/apt/lists/*
WORKDIR /html
COPY --from=builder2 /app/frontend/dist /html/app
COPY ./frontend/nginx/thapo-ska-${ARG_THAPO_SKA_ENV_PROFILE}.conf /etc/nginx/conf.d/default.conf
